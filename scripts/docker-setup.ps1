# üê≥ Docker Desktop Setup Helper

param(
    [switch]$CheckSystem = $false,
    [switch]$CheckDocker = $false,
    [switch]$CheckKubernetes = $false,
    [switch]$SetupGuide = $false,
    [switch]$TroubleshootDocker = $false,
    [switch]$InstallComponents = $false
)

function Write-ColorOutput {
    param([string]$Message, [string]$Color = "White")
    Write-Host $Message -ForegroundColor $Color
}

function Test-WindowsFeatures {
    Write-ColorOutput "üîç CHECKING WINDOWS FEATURES" "Blue"
    Write-ColorOutput "=============================" "Blue"
    Write-Host ""
    
    $features = @(
        @{Name="Microsoft-Windows-Subsystem-Linux"; DisplayName="WSL"; Required=$true},
        @{Name="VirtualMachinePlatform"; DisplayName="Virtual Machine Platform"; Required=$true},
        @{Name="Microsoft-Hyper-V"; DisplayName="Hyper-V"; Required=$false}
    )
    
    $allEnabled = $true
    
    foreach ($feature in $features) {
        try {
            $state = Get-WindowsOptionalFeature -Online -FeatureName $feature.Name -ErrorAction Stop
            if ($state.State -eq "Enabled") {
                Write-ColorOutput "‚úÖ $($feature.DisplayName): Enabled" "Green"
            } else {
                $status = if ($feature.Required) { "‚ùå" } else { "‚ö†Ô∏è" }
                $color = if ($feature.Required) { "Red" } else { "Yellow" }
                Write-ColorOutput "$status $($feature.DisplayName): Disabled" $color
                if ($feature.Required) { $allEnabled = $false }
            }
        }
        catch {
            Write-ColorOutput "‚ùå $($feature.DisplayName): Could not check (may need admin rights)" "Red"
            if ($feature.Required) { $allEnabled = $false }
        }
    }
    
    Write-Host ""
    
    if (-not $allEnabled) {
        Write-ColorOutput "‚ö†Ô∏è  Required Windows features are missing" "Yellow"
        Write-ColorOutput "üí° Run with -InstallComponents to enable required features" "Cyan"
    } else {
        Write-ColorOutput "‚úÖ All required Windows features are enabled" "Green"
    }
    
    return $allEnabled
}

function Test-DockerInstallation {
    Write-ColorOutput "üê≥ CHECKING DOCKER INSTALLATION" "Blue"
    Write-ColorOutput "===============================" "Blue"
    Write-Host ""
    
    $dockerOk = $true
    
    # Check if Docker is installed
    try {
        $dockerVersion = docker --version 2>$null
        Write-ColorOutput "‚úÖ Docker CLI: $dockerVersion" "Green"
    }
    catch {
        Write-ColorOutput "‚ùå Docker CLI not found" "Red"
        Write-ColorOutput "üí° Download from: https://www.docker.com/products/docker-desktop/" "Yellow"
        return $false
    }
    
    # Check if Docker daemon is running
    try {
        $dockerInfo = docker info 2>$null
        Write-ColorOutput "‚úÖ Docker daemon is running" "Green"
    }
    catch {
        Write-ColorOutput "‚ùå Docker daemon not running" "Red"
        Write-ColorOutput "üí° Start Docker Desktop application" "Yellow"
        $dockerOk = $false
    }
    
    # Check Docker Desktop version
    try {
        $dockerDesktopPath = "${env:ProgramFiles}\Docker\Docker\Docker Desktop.exe"
        if (Test-Path $dockerDesktopPath) {
            Write-ColorOutput "‚úÖ Docker Desktop installed" "Green"
        } else {
            Write-ColorOutput "‚ö†Ô∏è  Docker Desktop not found in standard location" "Yellow"
        }
    }
    catch {
        Write-ColorOutput "‚ö†Ô∏è  Could not locate Docker Desktop" "Yellow"
    }
    
    return $dockerOk
}

function Test-KubernetesInDocker {
    Write-ColorOutput "‚ò∏Ô∏è CHECKING KUBERNETES IN DOCKER" "Blue"
    Write-ColorOutput "==================================" "Blue"
    Write-Host ""
    
    # Check kubectl availability
    try {
        $kubectlVersion = kubectl version --client --short 2>$null
        Write-ColorOutput "‚úÖ kubectl CLI: Available" "Green"
    }
    catch {
        Write-ColorOutput "‚ùå kubectl not found" "Red"
        Write-ColorOutput "üí° kubectl is included with Docker Desktop when Kubernetes is enabled" "Yellow"
        return $false
    }
    
    # Check cluster connectivity
    try {
        $clusterInfo = kubectl cluster-info 2>$null
        $context = kubectl config current-context 2>$null
        
        if ($context -like "*docker-desktop*") {
            Write-ColorOutput "‚úÖ Kubernetes cluster: Connected (Docker Desktop)" "Green"
            
            # Check nodes
            $nodes = kubectl get nodes --no-headers 2>$null
            if ($nodes) {
                $nodeCount = ($nodes -split "`n").Count
                Write-ColorOutput "‚úÖ Kubernetes nodes: $nodeCount node(s) ready" "Green"
            }
            
            return $true
        } else {
            Write-ColorOutput "‚ö†Ô∏è  Connected to cluster: $context (not Docker Desktop)" "Yellow"
            Write-ColorOutput "üí° Switch context to docker-desktop or enable Kubernetes in Docker Desktop" "Yellow"
            return $false
        }
    }
    catch {
        Write-ColorOutput "‚ùå Kubernetes cluster not accessible" "Red"
        Write-ColorOutput "üí° Enable Kubernetes in Docker Desktop Settings" "Yellow"
        return $false
    }
}

function Install-WindowsComponents {
    Write-ColorOutput "üõ†Ô∏è  INSTALLING REQUIRED WINDOWS COMPONENTS" "Green"
    Write-ColorOutput "==========================================" "Green"
    Write-Host ""
    
    # Check if running as administrator
    $isAdmin = ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
    
    if (-not $isAdmin) {
        Write-ColorOutput "‚ùå This operation requires administrator privileges" "Red"
        Write-ColorOutput "üí° Right-click PowerShell and 'Run as Administrator'" "Yellow"
        return $false
    }
    
    try {
        Write-ColorOutput "üì¶ Enabling Windows Subsystem for Linux..." "Blue"
        dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
        
        Write-ColorOutput "üì¶ Enabling Virtual Machine Platform..." "Blue"
        dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
        
        Write-ColorOutput "‚úÖ Windows components enabled successfully" "Green"
        Write-ColorOutput "üîÑ A restart is required to complete the installation" "Yellow"
        
        $restart = Read-Host "Restart computer now? (y/N)"
        if ($restart -eq 'y' -or $restart -eq 'Y') {
            Write-ColorOutput "üîÑ Restarting computer..." "Yellow"
            Restart-Computer -Force
        } else {
            Write-ColorOutput "‚ö†Ô∏è  Please restart your computer manually to complete the setup" "Yellow"
        }
        
        return $true
    }
    catch {
        Write-ColorOutput "‚ùå Failed to install Windows components: $_" "Red"
        return $false
    }
}

function Show-DockerSetupGuide {
    Write-ColorOutput "üê≥ DOCKER DESKTOP SETUP GUIDE" "Cyan"
    Write-ColorOutput "==============================" "Cyan"
    Write-Host ""
    
    Write-ColorOutput "üìã STEP-BY-STEP INSTALLATION:" "Yellow"
    Write-Host ""
    
    Write-ColorOutput "1. üîß Prepare Windows:" "White"
    Write-ColorOutput "   ‚Ä¢ Run: .\docker-setup.ps1 -InstallComponents" "Gray"
    Write-ColorOutput "   ‚Ä¢ Restart computer when prompted" "Gray"
    Write-Host ""
    
    Write-ColorOutput "2. üì• Download Docker Desktop:" "White"
    Write-ColorOutput "   ‚Ä¢ Go to: https://www.docker.com/products/docker-desktop/" "Gray"
    Write-ColorOutput "   ‚Ä¢ Click 'Download for Windows'" "Gray"
    Write-ColorOutput "   ‚Ä¢ Run installer as Administrator" "Gray"
    Write-Host ""
    
    Write-ColorOutput "3. ‚öôÔ∏è Configure Docker Desktop:" "White"
    Write-ColorOutput "   ‚Ä¢ Enable Kubernetes in Settings" "Gray"
    Write-ColorOutput "   ‚Ä¢ Set memory to 8GB+ (Settings ‚Üí Resources)" "Gray"
    Write-ColorOutput "   ‚Ä¢ Apply and restart" "Gray"
    Write-Host ""
    
    Write-ColorOutput "4. ‚úÖ Verify Installation:" "White"
    Write-ColorOutput "   ‚Ä¢ Run: .\docker-setup.ps1 -CheckDocker" "Gray"
    Write-ColorOutput "   ‚Ä¢ Run: .\docker-setup.ps1 -CheckKubernetes" "Gray"
    Write-Host ""
    
    Write-ColorOutput "üîó HELPFUL LINKS:" "Cyan"
    Write-ColorOutput "   ‚Ä¢ Docker Desktop: https://www.docker.com/products/docker-desktop/" "Blue"
    Write-ColorOutput "   ‚Ä¢ WSL2 Update: https://aka.ms/wsl2kernel" "Blue"
    Write-ColorOutput "   ‚Ä¢ Troubleshooting: https://docs.docker.com/desktop/troubleshoot/" "Blue"
}

function Troubleshoot-Docker {
    Write-ColorOutput "üîß DOCKER TROUBLESHOOTING" "Yellow"
    Write-ColorOutput "==========================" "Yellow"
    Write-Host ""
    
    Write-ColorOutput "üîç COMMON ISSUES AND SOLUTIONS:" "Cyan"
    Write-Host ""
    
    Write-ColorOutput "‚ùå Docker Desktop won't start:" "Red"
    Write-ColorOutput "   ‚Ä¢ Check Windows features are enabled" "Gray"
    Write-ColorOutput "   ‚Ä¢ Restart Docker Desktop as Administrator" "Gray"
    Write-ColorOutput "   ‚Ä¢ Reset Docker Desktop (Settings ‚Üí Troubleshoot ‚Üí Reset)" "Gray"
    Write-Host ""
    
    Write-ColorOutput "‚ùå Kubernetes stuck 'Starting':" "Red"
    Write-ColorOutput "   ‚Ä¢ Reset Kubernetes cluster (Settings ‚Üí Kubernetes)" "Gray"
    Write-ColorOutput "   ‚Ä¢ Increase Docker memory allocation" "Gray"
    Write-ColorOutput "   ‚Ä¢ Check firewall/antivirus blocking Docker" "Gray"
    Write-Host ""
    
    Write-ColorOutput "‚ùå 'docker' command not found:" "Red"
    Write-ColorOutput "   ‚Ä¢ Restart PowerShell/Command Prompt" "Gray"
    Write-ColorOutput "   ‚Ä¢ Check Docker Desktop is running" "Gray"
    Write-ColorOutput "   ‚Ä¢ Reinstall Docker Desktop" "Gray"
    Write-Host ""
    
    Write-ColorOutput "üõ†Ô∏è DIAGNOSTIC COMMANDS:" "Cyan"
    Write-ColorOutput "   docker system info" "Gray"
    Write-ColorOutput "   docker system events" "Gray"
    Write-ColorOutput "   kubectl config current-context" "Gray"
    Write-ColorOutput "   kubectl get nodes" "Gray"
}

function Show-MainMenu {
    Write-ColorOutput "üê≥ DOCKER DESKTOP SETUP HELPER" "Cyan"
    Write-ColorOutput "===============================" "Cyan"
    Write-Host ""
    
    Write-ColorOutput "Choose an option:" "White"
    Write-ColorOutput "1. üîç Check system requirements" "Yellow"
    Write-ColorOutput "2. üê≥ Check Docker installation" "Yellow"
    Write-ColorOutput "3. ‚ò∏Ô∏è Check Kubernetes setup" "Yellow"
    Write-ColorOutput "4. üìã Show setup guide" "Yellow"
    Write-ColorOutput "5. üõ†Ô∏è Install Windows components" "Yellow"
    Write-ColorOutput "6. üîß Troubleshooting guide" "Yellow"
    Write-ColorOutput "7. üö™ Exit" "Yellow"
    Write-Host ""
    
    $choice = Read-Host "Select option (1-7)"
    
    switch ($choice) {
        "1" { Test-WindowsFeatures }
        "2" { Test-DockerInstallation }
        "3" { Test-KubernetesInDocker }
        "4" { Show-DockerSetupGuide }
        "5" { Install-WindowsComponents }
        "6" { Troubleshoot-Docker }
        "7" { Write-ColorOutput "üëã Goodbye!" "Green"; return }
        default { Write-ColorOutput "‚ùå Invalid option" "Red" }
    }
    
    Write-Host ""
    Read-Host "Press Enter to continue"
    Show-MainMenu
}

# Main execution
if ($CheckSystem) {
    Test-WindowsFeatures
} elseif ($CheckDocker) {
    Test-DockerInstallation
} elseif ($CheckKubernetes) {
    Test-KubernetesInDocker
} elseif ($SetupGuide) {
    Show-DockerSetupGuide
} elseif ($TroubleshootDocker) {
    Troubleshoot-Docker
} elseif ($InstallComponents) {
    Install-WindowsComponents
} else {
    Show-MainMenu
}